%!PS-Adobe-3.0 EPSF-3.0
%%EndComments
% emacs ps-mode C-c C-c to preview, C-c C-b to debug
% Public domain licence
%%BeginProlog
% What idiomatically goes here? See Document Structuring Conventions
%%EndProlog
/mm {25.4 div 72 mul} def % generally work in points to be idiomatic though
/pagewidth 297 mm def % FIXME formally?
/pageheight 210 mm def
/margin 10 mm def
<< /PageSize [pagewidth pageheight]
   /PageOffset [margin margin]
>> setpagedevice
/w pagewidth margin 2 mul sub def
/h pageheight margin 2 mul sub def
/y {neg h add} def % flip y axis without transforming everything e.g. text

/brewer [ % colorbrewer2.org: 9 classes qualtiative print friendly
    [228 26 28] % red
    [55 126 184] % blue
    [77 175 74] % green
    [152 78 163] % purple
    [255 127 0] % orange
    [255 255 51] % yellow
    [166 86 40] % brown
    [247 129 191] % pink
    [153 153 153] % grey
] def
/setbrew { % brewer index to setrgbcolor, effectively pops arg
    brewer exch get % zero-indexed
    { 255 div } forall
    setrgbcolor
} def
/row {10 mul y margin sub} def % row-n to y-offset
/starthour 4 def
/dayswide 1 def
/time { % d hh mm to x-offset (d is zero-based day count)
    3 -1 roll 24 mul
    3 -1 roll add
    starthour sub 60 mul add
    1440 dayswide mul div
    w mul
} def
/zeropad { % stack: int width
    1 dict begin % scope dict
    /width exch def
    /num exch def
    /actual num 1 gt {num} {1} ifelse log floor cvi 1 add def
    /need actual width gt {actual} {width} ifelse def
    /container 10 need exp cvi def
    container num add
    need 1 add string cvs
    1 need getinterval
    end % scope dict
} def
/seg { % time segment as coloured horizontal line
    % stack: nth-row start-offset end-offset type
    newpath
    1 dict begin
    gsave % scope graphics...
    setbrew
    /finish exch def
    /start exch def
    /nth exch def
    start nth row moveto
    finish start sub 0 rlineto
    5 setlinewidth
    stroke
    grestore
    end
} def
/label {
    % stack: nth-row label
    1 dict begin
    gsave
    /lbl exch def % managed to clobber /label despite scope dict?
    /nth exch def
    0 nth row moveto
    0 setgray
    lbl show
    grestore
    end
} def
% 210 25.4 div 72 mul 0 translate 90 rotate % landscape
/Helvetica findfont 10 scalefont setfont
0 1 24 dayswide mul { % hour markers
    newpath % seems to accommodate inner `show`, and is ?optional
    1 dict begin
    /hour exch starthour add def
    /day hour 24 idiv def
    day hour 24 mod 0 time 0 y moveto
    0.5 setgray
    gsave
    2 -10 rmoveto
    hour 24 mod 2 zeropad show
    grestore
    0 pageheight margin 2 mul sub neg rlineto
    hour 24 mod 0 eq {2} {0.5} ifelse setlinewidth
    0.9 setgray
    stroke
    end
} for
0 (label-one) label
0 0 08 30 time 0 10 30 time 0 seg
0 0 10 33 time 0 12 01 time 2 seg
0 0 12 01 time 0 14 22 time 3 seg
1 (label-two) label
1 0 10 15 time 0 17 29 time 5 seg
1 0 17 30 time 0 19 42 time 1 seg
1 0 20 00 time 1 01 23 time 4 seg
showpage
%%EOF
